# Архитектура модуля «Сервис "Земля просто"»

## 1. Контекст и цели

Модуль обеспечивает цифровизацию процесса предоставления земельных участков, находящихся в
государственной или муниципальной собственности, от поиска и образования земельного участка до
формирования пакета документов для обращения в государственные и муниципальные органы.
Сервис публикуется на Публичном портале Национальной системы пространственных данных (НСПД)
и взаимодействует с ФГИС ЕПГУ, ГИСОГД РФ и иными ведомственными системами.

Основные цели:

- исключить множественные посещения ведомств за счет end-to-end цифрового процесса;
- предоставить пользователю (физическому или юридическому лицу) инструменты для
  самостоятельного моделирования границ участка и выбора готовых участков из перечней;
- автоматизировать подготовку комплектов документов на основе созданного или выбранного участка;
- обеспечить исполнение этапов бизнес-процессов госуслуг уполномоченными органами в рамках
  единого сервиса;
- формировать и сопровождать слой «Земля просто» для публикации на Публичном портале НСПД.

## 2. Пользовательские роли

| Роль | Описание | Основные сценарии |
|------|----------|-------------------|
| Заявитель | Физическое или юридическое лицо | Поиск и моделирование участка, выбор готовых участков, формирование пакета документов, отслеживание статусов обращений |
| Оператор органа власти | Сотрудник уполномоченного органа | Выполнение этапов бизнес-процессов госуслуг, согласование, подготовка решений |
| Администратор НСПД | Техподдержка портала | Настройка справочников, мониторинг сервисов, управление доступом |

## 3. Ограничения и допущения

- Идентификация и авторизация заявителей выполняются средствами НСПД, сервис работает в контуре
  доверенной аутентификации и получает атрибуты пользователя по OIDC.
- Запуск бизнес-процессов и обмен документами с ФГИС ЕПГУ выполняется через интеграционный шлюз
  НСПД; внутри сервиса реализуются только те шаги, которые не покрываются ФГИС ЕПГУ.
- Все пространственные данные хранятся в PostgreSQL/PostGIS, публикация слоев выполняется через
  GeoServer.
- Асинхронный обмен событиями реализуется через Kafka (или совместимую шину сообщений).
- Требования по безопасности соответствуют методическим рекомендациям ФСТЭК/ФСБ для
  государственных информационных систем.

## 4. Высокоуровневая архитектура

```
[Публичный портал НСПД]
        |
        v
[ API Gateway / BFF ] --OIDC--> [ Identity Provider НСПД ]
        |
        +--> [ Plot Designer Service ]
        +--> [ Plot Catalog Service ]
        +--> [ Document Assembly Service ]
        +--> [ Workflow Orchestrator ]
        +--> [ Digital Assistant Service ]
        +--> [ Layer Management Service ]
        |
        +--> [ Integration Service ] --> [ ГИСОГД РФ, ФГИС ЕПГУ, Росреестр ]

Shared инфраструктура: PostgreSQL/PostGIS, S3-совместимое файловое хранилище, Kafka, Redis, GeoServer
```

Каждый сервис реализован на Go, взаимодействие между сервисами — через gRPC (для
высоконагруженных сценариев) и асинхронные события в Kafka. Для внешних потребителей сервисы
публикуют REST/GraphQL API через API Gateway.

## 5. Описание доменных сервисов

### 5.1 Plot Designer Service

Назначение: создание и модификация границ контуров земельных участков.

Функциональность:

- рисование контура на карте (веб-компонент на стороне фронта + API для сохранения GeoJSON);
- импорт координат характерных точек (WKT/WKB, CSV);
- импорт геометрии из внешних ГИС (через загрузку файлов или WFS-сервисы);
- автоматический расчёт площадей, проверка пересечений с ограничениями (охраняемые зоны,
  инженерные сети, водоохранные зоны);
- сохранение черновиков контуров, версионирование изменений.

### 5.2 Plot Catalog Service

Назначение: каталогизация и публикация готовых участков ("Участки для стройки", "Участки для
туризма").

Функциональность:

- хранение метаданных участков, статусов доступности, правовых ограничений;
- фильтры и подбор участков по жизненным ситуациям (типы деятельности, инфраструктура);
- выдача списков участков и геометрий для отображения на карте;
- синхронизация с внешними реестрами (например, региональные перечни участков).

### 5.3 Document Assembly Service

Назначение: автоматическое формирование пакетов документов (заявления, схемы, кадастровые
планы, пояснительные записки) для подачи обращения.

Функциональность:

- шаблонизация документов (DOCX, PDF, XML);
- генерация графических материалов на основе геометрии (GeoJSON → PNG/PDF);
- интеграция с электронными подписями и доверенными сервисами хранения;
- выгрузка комплектов в архив (ZIP) и передача в ФГИС ЕПГУ.

### 5.4 Workflow Orchestrator

Назначение: реализация этапов бизнес-процессов госуслуг в части, не покрытой ФГИС ЕПГУ.

Функциональность:

- моделирование процессов в BPMN 2.0 и исполнение с помощью Camunda/Temporal;
- управление задачами операторов, трекинг статусов и SLA;
- интеграция с документооборотом органов власти;
- ведение журнала действий и аудита.

### 5.5 Digital Assistant Service

Назначение: диалоговая поддержка заявителя при создании контуров, выборе участка и формировании
документов.

Функциональность:

- сценарные диалоги (finite state machine) + NLP-модель для распознавания намерений;
- контекстная подсказка по жизненным ситуациям и требованиям к документам;
- подсветка ошибок в заполнении данных;
- генерация чек-листов перед отправкой заявления.

### 5.6 Layer Management Service

Назначение: формирование слоя «Земля просто» для отображения на Публичном портале НСПД.

Функциональность:

- агрегация данных из Plot Designer/Plot Catalog;
- публикация слоёв в GeoServer через REST API;
- управление версиями и расписание обновлений слоёв;
- контроль качества (валидность геометрий, полнота атрибутов).

### 5.7 Integration Service

Назначение: обмен данными с внешними системами (ГИСОГД РФ, Росреестр, ФГИС ЕПГУ).

Функциональность:

- адаптеры под SOAP/REST/gRPC интерфейсы ведомств;
- трансформация форматов (XML↔JSON↔GML);
- управление очередями запросов и мониторинг ошибок;
- безопасность (криптография, ЭЦП, VPN-каналы).

## 6. Логическая схема данных

Основные сущности:

- `PlotContour`: идентификатор, GeoJSON, статус, владелец (заявитель), площадь, ограничения.
- `PlotCandidate`: ссылка на перечень, геометрия, классификаторы жизненных ситуаций.
- `DocumentPackage`: состав файлов, статус формирования, ссылки на исходные данные.
- `WorkflowInstance`: тип процесса, текущий шаг, исполнитель, сроки.
- `AssistantSession`: идентификатор пользователя, активный сценарий, история диалога.

PostgreSQL/PostGIS хранит геометрию в типе `Geometry(Polygon, SRID)`. Файлы документов
сохраняются в S3-совместимом хранилище (например, MinIO).

## 7. Интеграция и взаимодействие

| Поток | Направление | Технология | Примечание |
|-------|-------------|------------|------------|
| Аутентификация | Портал НСПД → API Gateway | OIDC | получение токенов доступа |
| Создание контура | Портал → Plot Designer | REST/gRPC + GeoJSON | сохранение черновика |
| Выбор участка | Портал → Plot Catalog | GraphQL | фильтрация по критериям |
| Формирование документов | Портал → Document Assembly | REST | запуск генерации пакета |
| Оркестрация | Document Assembly → Workflow | Kafka events | переходы стадий |
| Публикация слоя | Layer Management → GeoServer | REST | обновление слоя |
| Обмен с внешними системами | Integration Service ↔ ГИСОГД/ФГИС ЕПГУ | SOAP/REST, VPN | запросы сведений |

## 8. Нефункциональные требования

- **Надёжность:** кластер Kubernetes, горизонтальное масштабирование stateless-сервисов, репликация
  PostgreSQL, резервное копирование S3.
- **Производительность:** целевой отклик API < 1 секунды при 95-м перцентиле для операций чтения,
  < 3 секунд для формирования документов.
- **Безопасность:** RBAC, журналирование действий, соответствие 152-ФЗ (персональные данные).
- **Наблюдаемость:** централизованный логинг (ELK), метрики (Prometheus/Grafana), трассировка (Jaeger).

## 9. Карта жизненных ситуаций

Жизненные ситуации определяют сценарии подбора участка:

1. Строительство жилья (ИЖС, многоквартирные дома)
2. Размещение промышленных объектов
3. Развитие туризма и рекреации
4. Сельское хозяйство
5. Социальная инфраструктура (школы, больницы)
6. Инвестиционные проекты регионов

Каждая ситуация сопоставляется с фильтрами в каталоге и шаблонами документов.

## 10. Каркас реализации на Go

Сервисы разделяются на независимые Go-приложения с общими библиотеками:

- `cmd/gateway` — HTTP API и BFF.
- `cmd/plot-designer`, `cmd/plot-catalog`, `cmd/document-assembly`, `cmd/workflow`, `cmd/assistant`,
  `cmd/layer`, `cmd/integration` — самостоятельные бинарники.
- `internal/<domain>` — доменная логика.
- `pkg/<shared>` — общие библиотеки (клиенты БД, очередей, GeoJSON-утилиты).

Коммуникации:

- gRPC для внутренних запросов (`proto/` файлы, генерация через `buf`).
- Kafka topics: `plot.contour.created`, `plot.package.ready`, `workflow.task.completed`, `layer.updated`.

CI/CD: GitLab CI, линтеры (`golangci-lint`), тесты, сборка контейнеров, деплой в Kubernetes.

## 11. План работ по разработке ЧТЗ

1. Сбор и детализация требований с уполномоченными органами.
2. Разработка пользовательских сценариев и UX-прототипов.
3. Проработка интеграций с ГИСОГД и ФГИС ЕПГУ (протоколы, форматы).
4. Определение SLA, требований по безопасности и резервированию.
5. Подготовка детализации бизнес-процессов и регламентов взаимодействия.
6. Определение данных для слоя «Земля просто» и их периодичности обновления.

## 12. Заключение

Предложенная архитектура на Go обеспечивает модульность, масштабируемость и соответствие
требованиям к сервису «Земля просто». Детализация функций и интерфейсов позволяет приступить к
разработке ЧТЗ и реализации прототипов сервисов.

